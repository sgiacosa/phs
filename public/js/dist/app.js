var appModule=angular.module("sien",["ngAnimate","ngRoute","uiGmapgoogle-maps","firebase","ui.bootstrap","angularMoment","angular-jwt","btford.socket-io","oitozero.ngSweetAlert","luegg.directives"]);appModule.constant("angularMomentConfig",{timezone:"America/Argentina/Buenos_Aires"}),appModule.config(["$httpProvider",function(a){a.interceptors.push("authInterceptor")}]),appModule.config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){b.html5Mode(!0),a.when("/",{templateUrl:"partial/list.html",controller:"ListController"}).when("/nuevo",{templateUrl:"partial/nuevoLlamado.html",controller:"NuevoController"}).when("/llamados",{templateUrl:"partial/buscarLlamados.html",controller:"BuscarLlamadosController"}).when("/evento/:id",{templateUrl:"partial/evento.html",controller:"EventoController"}).when("/search",{templateUrl:"partial/search.html",controller:"SearchController"}).when("/login",{templateUrl:"partial/login.html",controller:"LoginController"}).when("/logout",{templateUrl:"partial/login.html",controller:"LoginController"}).when("/changepassword",{templateUrl:"partial/changepassword.html",controller:"LoginController"}).when("/monitor",{templateUrl:"partial/monitor.html",controller:"monitorController"})}]),appModule.filter("diferencia",function(){return function(a,b,c){var d=moment.duration(moment(b).diff(moment(a))).format("hh:mm");return d}}),appModule.directive("flujo",["$filter","$http","$timeout","SearchService",function(a,b,c,d){return{restrict:"E",scope:{color:"=color",descripcion:"=descripcion",modoEdicion:"=modoedicion"},templateUrl:"directives/templates/flujo.html",transclude:!0,link:function(c,e){c.actualizar=!1,c.facts=[],c.Pila=[],c.CIE10SearchResult=[],b.get("js/rules.nools").then(function(a){nools.getFlow("Categorizacion SIEN")?c.flow=nools.getFlow("Categorizacion SIEN"):c.flow=nools.compile(a.data,{name:"Categorizacion SIEN"}),c.Regla=c.flow.getDefined("Regla")}),c.$watch("modoEdicion",function(a,b){angular.equals(a,b)||0==a&&(c.actualizar=!1)},!0),c.initFlujo=function(){c.facts=[],c.Pila=[],c.actualizar=!0,c.registro=new c.Regla({id_regla:0,nombre:"lala",descripcion:"",tipo:1,color:1,valor:null}),c.facts.push(c.registro),c.next(0,null)},c.AsignarColor=function(){var a=c.Pila;a.push(c.facts[0]),c.color=Math.max.apply(Math,a.map(function(a){return a.color})),c.descripcion=a.map(function(a){return a.descripcion}).filter(function(a){if(a.length>1)return a}).join(" - "),a.pop()},c.next=function(b,d){var e=a("filter")(c.facts,{id_regla:parseInt(b)},!0)[0];null!=d&&(e.valor=d),c.Pila.push(e),c.facts=[];var f=c.flow.getSession(e);f.on("acierto",function(a){c.facts.push(a)}),f.match().then(function(){c.AsignarColor(),c.$apply()},function(a){console.error(a.stack)})},c.prev=function(){0==c.facts.length&&(c.Pila.pop(),c.Pila.pop()),1!=c.Pila.length&&c.Pila.pop();var a=c.Pila[c.Pila.length-1];c.facts=[];var b=c.flow.getSession(a);b.on("acierto",function(a){c.facts.push(a)}),b.match().then(function(){c.AsignarColor(),c.$apply()},function(a){console.error(a.stack)})},c.cie10_SelectChange=function(){c.color=this.color},c.BuscarCie10=function(a){return!a||a.length<3||void d.searchCie10(a).then(function(a){if(200==a.status){for(var b=[],d=0,e=a.data.length;d<e;d++)b.push(a.data[d].nombre);c.CIE10SearchResult=b}else alert("Error - verifique la conexi贸n a internet.")})},c.Cie10Seleccionado=function(){c.descripcion=this.cie10}}}}]),appModule.directive("autocomplete",function(){var a=-1;return{restrict:"E",scope:{searchParam:"=ngModel",suggestions:"=data",onType:"=onType",onSelect:"=onSelect",autocompleteRequired:"=",onBlur:"@"},controller:["$scope",function(a){a.selectedIndex=-1,a.initLock=!0,a.setIndex=function(b){a.selectedIndex=parseInt(b)},this.setIndex=function(b){a.setIndex(b),a.$apply()},a.getIndex=function(b){return a.selectedIndex};var b=!0;a.completing=!1,a.$watch("searchParam",function(c,d){d===c||!d&&a.initLock||(b&&"undefined"!=typeof a.searchParam&&null!==a.searchParam&&(a.completing=!0,a.searchFilter=a.searchParam,a.selectedIndex=-1),a.onType&&a.onType(a.searchParam))}),this.preSelect=function(c){b=!1,a.$apply(),b=!0},a.preSelect=this.preSelect,this.preSelectOff=function(){b=!0},a.preSelectOff=this.preSelectOff,a.select=function(c){c&&(a.searchParam=c.text,a.searchFilter=c.text,a.onSelect&&a.onSelect(c)),b=!1,a.completing=!1,setTimeout(function(){b=!0},1e3),a.setIndex(-1)}}],link:function(b,c,d){setTimeout(function(){b.initLock=!1,b.$apply()},250);var e="";b.attrs={placeholder:"start typing...",class:"",id:"",inputclass:"",inputid:""};for(var f in d)e=f.replace("attr","").toLowerCase(),0===f.indexOf("attr")&&(b.attrs[e]=d[f]);d.clickActivation&&(c[0].onclick=function(a){b.searchParam||setTimeout(function(){b.completing=!0,b.$apply()},200)});var g={left:37,up:38,right:39,down:40,enter:13,esc:27,tab:9};document.addEventListener("keydown",function(a){var c=a.keyCode||a.which;switch(c){case g.esc:b.select(),b.setIndex(-1),b.$apply(),a.preventDefault()}},!0),c[0].addEventListener("blur",function(a){setTimeout(function(){b.select(),b.setIndex(-1),null!=d.onBlur&&b.$parent.$apply(d.onBlur),b.$apply()},150)},!0),c[0].addEventListener("keydown",function(c){var d=c.keyCode||c.which,e=angular.element(this).find("li").length;if(b.completing&&0!=e)switch(d){case g.up:if(a=b.getIndex()-1,a<-1)a=e-1;else if(a>=e){a=-1,b.setIndex(a),b.preSelectOff();break}b.setIndex(a),a!==-1&&b.preSelect(angular.element(angular.element(this).find("li")[a]).text()),b.$apply();break;case g.down:if(a=b.getIndex()+1,a<-1)a=e-1;else if(a>=e){a=-1,b.setIndex(a),b.preSelectOff(),b.$apply();break}b.setIndex(a),a!==-1&&b.preSelect(angular.element(angular.element(this).find("li")[a]).text());break;case g.left:break;case g.right:case g.enter:case g.tab:a=b.getIndex(),a!==-1?(b.select(b.suggestions[angular.element(angular.element(this).find("li")[a]).attr("index")]),d==g.enter&&c.preventDefault()):d==g.enter&&b.select(),b.setIndex(-1),b.$apply();break;case g.esc:b.select(),b.setIndex(-1),b.$apply(),c.preventDefault();break;default:return}})},template:'        <div class="autocomplete {{ attrs.class }}" id="{{ attrs.id }}">          <textarea             type="text"            rows="3"            ng-model="searchParam"            placeholder="{{ attrs.placeholder }}"            class="{{ attrs.inputclass }}"            id="{{ attrs.inputid }}"            ng-required="{{ autocompleteRequired }}" /></textarea>          <ul ng-show="completing && (suggestions).length > 0">            <li              suggestion              ng-repeat="suggestion in suggestions | orderBy:\'toString()\' track by $index"              index="{{ $index }}"              val="lala{{ suggestion.text }}"              ng-class="{ active: ($index === selectedIndex) }"              ng-click="select(suggestion)"              ng-bind-html="suggestion.text  | highlight:searchParam"></li>          </ul>        </div>'}}),appModule.filter("highlight",["$sce",function(a){return function(b,c){if("function"==typeof b)return"";if(c){var d="("+c.split(/\ /).join(" |")+"|"+c.split(/\ /).join("|")+")",e=new RegExp(d,"gi");d.length&&(b=b.replace(e,'<span class="highlight">$1</span>'))}return a.trustAsHtml(b)}}]),appModule.directive("suggestion",function(){return{restrict:"A",require:"^autocomplete",link:function(a,b,c,d){b.bind("mouseenter",function(){d.preSelect(c.val),d.setIndex(c.index)}),b.bind("mouseleave",function(){d.preSelectOff()})}}}),appModule.directive("kmlmanager",["$filter",function(a){return{restrict:"E",scope:{kml:"=kml",map:"=map"},templateUrl:"directives/templates/kml.html",link:function(a,b,c){a.kmlArray=[];for(var d=null,e=0;e<a.kml.length;e++)d=new google.maps.KmlLayer({url:a.kml[e].url,map:a.kml[e].visible?a.map:null,preserveViewport:!0}),a.kmlArray.push({kml:d,visible:a.kml[e].visible,title:a.kml[e].title,icon:a.kml[e].icon});a.ToggleLayer=function(b){a.kmlArray[b].visible=!a.kmlArray[b].visible;for(var c=0;c<a.kmlArray.length;c++)a.kmlArray[c].kml.setMap(null),a.kmlArray[c].visible&&a.kmlArray[c].kml.setMap(a.map)}}}}]),appModule.controller("ListController",["$rootScope","$scope","$location","$window","RegistrosService","$filter","SalidasService","MensajesService","SearchService","UtilService","$http","LoginService","mySocket","$timeout",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){angular.extend(b,{loading:!1,loadingPrincipal:!0,registros:[],registroSeleccionado:null,finalizaciones:[],destinos:[],moviles:[],alertaCambios:!1,searchOptions:{mostrarEventosFinalizados:!1},initSocket:function(){m.on("connected",function(a){console.log("connected "+a)}),m.on("dbChange",function(a){b.actualizarRegistros()})},mostrarEvento:function(a){c.path("/evento/"+a)},nuevoLLamado:function(){c.path("/nuevo")},actualizarRegistros:function(){b.loading=!0,b.alertaCambios=!1,b.registros=[],e.listar(b.searchOptions.mostrarEventosFinalizados).then(function(a){b.registros=a,b.loading=!1})},generarTextoSMS:function(c){var d=f("filter")(b.registros,{_id:c})[0],e="";d.clasificacion&&(e="C贸digo "+(1==d.clasificacion?" Verde .":2==d.clasificacion?" Amarillo .":3==d.clasificacion?" Rojo .":" No clasificado. ")),e+=" Recibe pedido: "+f("date")(d.fechaRegistro,"HH:mm"),d.direccion&&(e+=" Direccion: "+d.direccion),d.observaciones&&(e+=" Anotaci贸n: "+d.observaciones),d.reporte&&(e+="Reporte: "+d.reporte);for(var g=0;g<d.mensajes.length;g++)e+=" Mensaje: "+d.mensajes[g].mensaje;for(var g=0;g<d.salidas.length;g++)e+="  Asiste: "+d.salidas[g].nombreMovil,e+=" Se despacha: "+f("date")(d.salidas[g].fechaDespacho,"HH:mm"),d.salidas[g].fechaEnMovimiento&&(e+=" -> Desplazamiento: "+f("date")(d.salidas[g].fechaEnMovimiento,"HH:mm")),d.salidas[g].fechaArribo&&(e+=" -> Arriba: "+f("date")(d.salidas[g].fechaArribo,"HH:mm")),d.salidas[g].fechaDestino&&(e+=" -> "+d.salidas[g].tipoSalida.nombre+" "+d.salidas[g].tipoSalida.destino+" : "+f("date")(d.salidas[g].fechaDestino,"HH:mm")),d.salidas[g].fechaQRU&&(e+=" -> QRU: "+f("date")(d.salidas[g].fechaQRU,"HH:mm")),d.salidas[g].fechaCancelacion&&(e+=" -> Cancelado: "+f("date")(d.salidas[g].fechaCancelacion,"HH:mm"));d.fechaCierre&&(e+=" Finaliza: "+f("date")(d.fechaCierre,"HH:mm")),a.$emit("eventDetailGenerated",e)},indicarMovimiento:function(a,c){b.loading=!0,g.indicarMovimiento(a,c).then(function(a){200==a.status||(SweetAlert.swal("Atenci贸n",a.data,"error"),b.loading=!1)})},indicarArribo:function(a,c){b.loading=!0,g.indicarArribo(a,c).then(function(a){200==a.status||(SweetAlert.swal("Atenci贸n",a.data,"error"),b.loading=!1)})},indicarQRU:function(a,c){b.loading=!0,g.indicarQRU(a,c).then(function(a){200==a.status||(SweetAlert.swal("Atenci贸n",a.data,"error"),b.loading=!1)})},init:function(){b.loadingPrincipal=!0,e.listar().then(function(a){b.registros=a,j.getConstantes().then(function(a){b.finalizaciones=a.tipos_salida,b.moviles=a.moviles,b.loadingPrincipal=!1}),b.userData=l.getUserData(),b.initSocket()}),b.$on("$destroy",function(){m.removeAllListeners()})}}),b.init()}]),appModule.controller("EventoController",["$scope","$location","$routeParams","RegistrosService","$filter","SalidasService","MensajesService","SearchService","UtilService","$http","SweetAlert","$timeout","mySocket",function(a,b,c,d,e,f,g,h,i,j,k,l,m){angular.extend(a,{evento:{},loading:!1,loadingPrincipal:!0,savingEvent:!1,nuevaSalida:!1,mostrarBotonGuardar:!1,googleMapLoading:!1,googleSearchInit:!1,streetSearchResult:null,watchRegistros:null,watchCoords:null,color:5,txtMensaje:{value:""},timeLine:[],opcionesSexo:[{id:1,name:"Masc"},{id:2,name:"Fem"}],descripcionFlujo:"",registros:[],registroSeleccionado:null,avoidGeoCode:!1,finalizaciones:[],destinos:[],moviles:[],showmap:!1,cityCoords:{latitude:-38.9513715362757,longitude:-68.0589395877441},map_alta:{center:{latitude:-38.9513715362757,longitude:-68.0589395877441},zoom:14,control:{}},marker_alta:{id:0,coords:{latitude:null,longitude:null},options:{draggable:!0}},kml:[{url:"http://www.google.com/maps/d/u/0/kml?mid=1WUYfyxf3toKH8LvIqU3IR-mphPo&lid=zV713s5UBi9s.k-L9mgOq5eas",visible:!1,title:"Cuadr铆culas",icon:"fa fa-car"},{url:"http://www.google.com/maps/d/u/0/kml?mid=1WUYfyxf3toKH8LvIqU3IR-mphPo&lid=zV713s5UBi9s.kkXrY9io13H0",visible:!1,title:"Comisarias",icon:"fa fa-home"},{url:"https://sien.neuquen.gov.ar/kml4.kml",visible:!1,title:"Z1",icon:"fa fa-map"}],initSocket:function(){console.log("init socket"),m.on("dbChange",function(b){b._id==a.registroSeleccionado._id&&(a.registroSeleccionado=b,a.initData())})},enviarMovil:function(b){a.cambiosSinGuardar()||(a.loading=!0,f.nuevaSalida(b,a.registroSeleccionado._id).then(function(b){200==b.status?(a.registroSeleccionado=b.data,a.initData()):k.swal("Atenci贸n",b.data,"error"),a.nuevaSalida=!1,a.loading=!1}))},indicarMovimiento:function(b){a.cambiosSinGuardar()||(a.loading=!0,f.indicarMovimiento(a.registroSeleccionado._id,b).then(function(b){200==b.status?(a.registroSeleccionado=b.data,a.initData()):(k.swal("Atenci贸n",b.data,"error"),a.loading=!1)}))},indicarArribo:function(b){a.cambiosSinGuardar()||(a.loading=!0,f.indicarArribo(a.registroSeleccionado._id,b).then(function(b){200==b.status?(a.registroSeleccionado=b.data,a.initData()):(k.swal("Atenci贸n",b.data,"error"),a.loading=!1)}))},indicarDestino:function(b){a.cambiosSinGuardar()||(a.loading=!0,f.indicarDestino(a.registroSeleccionado._id,b).then(function(b){200==b.status?(a.registroSeleccionado=b.data,a.initData()):(k.swal("Atenci贸n",b.data,"error"),a.loading=!1)}))},indicarQRU:function(b){a.cambiosSinGuardar()||(a.loading=!0,f.indicarQRU(a.registroSeleccionado._id,b).then(function(b){200==b.status?(a.registroSeleccionado=b.data,a.initData()):(k.swal("Atenci贸n",b.data,"error"),a.loading=!1)}))},cancelarSalida:function(b){a.cambiosSinGuardar()||k.swal({title:"Est谩 seguro que desea cancelar este despacho?",text:"Una vez cancelado no podr谩 ser modificado",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, cancelar el despacho.",closeOnConfirm:!0,closeOnCancel:!0},function(c){c&&(a.loading=!0,f.indicarCancelacion(a.registroSeleccionado._id,b).then(function(b){200==b.status?(a.registroSeleccionado=b.data,a.initData()):(k.swal("Atenci贸n",b.data,"error"),a.loading=!1)}))})},prepareNuevaSalida:function(){a.nuevaSalida=!0,a.moviles=[],a.loadingDistances=!0,f.getMovilesDisponibles(a.registroSeleccionado.coordenadas).then(function(b){for(var c=0;c<b.data.length;c++)a.registroSeleccionado.coordenadas?"1"==b.data[c].obj.estado&&a.moviles.push(b.data[c]):"1"==b.data[c].estado&&a.moviles.push({_id:b.data[c]._id,nombre:b.data[c].nombre,distancia:"-"});a.loadingDistances=!1})},generarObjetoTimeLine:function(){a.timeLine=[],a.timeLine.push({fecha:a.registroSeleccionado.fechaRegistro,titulo:"Registra el evento",usuario:"Usuario com煤n",descripcion:"Clasificaci贸n: "+e("filter")([{id:0,name:"No especificada"},{id:1,name:"Verde"},{id:2,name:"Amarillo"},{id:3,name:"Rojo"}],{id:a.registroSeleccionado.clasificacion})[0].name,tipo:1}),a.registroSeleccionado.salidas.forEach(function(b){a.timeLine.push({fecha:b.fechaDespacho,titulo:"Despacho ",descripcion:b.nombreMovil,usuario:"",tipo:2}),b.fechaArribo&&a.timeLine.push({fecha:b.fechaArribo,titulo:"Arriba ",descripcion:b.nombreMovil,usuario:"",tipo:2}),b.fechaDestino&&a.timeLine.push({fecha:b.fechaDestino,titulo:"Destino",usuario:"",tipo:2,descripcion:b.nombreMovil+": "+b.tipoSalida.nombre+" "+b.tipoSalida.destino}),b.fechaQRU&&a.timeLine.push({fecha:b.fechaQRU,titulo:"QRU ",descripcion:b.nombreMovil,usuario:"",tipo:2}),b.fechaCancelacion&&a.timeLine.push({fecha:b.fechaCancelacion,titulo:"Cancelado ",descripcion:b.nombreMovil,usuario:"",tipo:2})}),a.registroSeleccionado.mensajes.forEach(function(b){a.timeLine.push({fecha:b.fecha,titulo:"Mensaje ",descripcion:b.mensaje,usuario:"",tipo:4})}),a.registroSeleccionado.fechaCierre&&a.timeLine.push({fecha:a.registroSeleccionado.fechaCierre,titulo:"Cierre del evento",usuario:"",tipo:3})},cerrarRegistro:function(){a.cambiosSinGuardar()||k.swal({title:"Est谩 seguro que desea cerrar este evento?",text:"Una vez modificado no podr谩 ser modificado",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, cerrar el evento",closeOnConfirm:!0,closeOnCancel:!0},function(b){b&&(a.loading=!0,d.cerrarRegistro(a.registroSeleccionado._id).then(function(b){200==b.status?(a.mostrarBotonGuardar=!1,a.registroSeleccionado=b.data,a.initData()):403==b.status?l(function(){k.swal("Atenci贸n",b.data,"info")},100):l(function(){k.swal("Error en el servidor",b.data,"error")},100),a.loading=!1}))})},enviarMensaje:function(){if(a.txtMensaje.value){var b={mensaje:a.txtMensaje.value,fecha:null};a.registroSeleccionado.mensajes.push(b),a.txtMensaje.value=""}},guardarCambios:function(){a.loading=!0,a.savingEvent=!0,d.guardarCambios(a.registroSeleccionado).then(function(b){200==b.status?(a.mostrarBotonGuardar=!1,a.registroSeleccionado=b.data,a.initData()):k.swal("Atenci贸n","Error al intentar guardar los datos.","error"),a.loading=!1,a.savingEvent=!1})},cancelarCambios:function(){a.StopWatch(),b.path("/")},initData:function(b){a.StopWatch(),a.registroSeleccionado.coordenadas&&2==a.registroSeleccionado.coordenadas.length&&(a.marker_alta.coords.longitude=a.registroSeleccionado.coordenadas[0],a.marker_alta.coords.latitude=a.registroSeleccionado.coordenadas[1],a.map_alta.control.refresh({latitude:a.registroSeleccionado.coordenadas[1],longitude:a.registroSeleccionado.coordenadas[0]})),a.mostrarBotonGuardar=!1;var c=e("filter")(a.registroSeleccionado.pacientes,function(a){if(""==a.edad&&""==a.nombre)return!0});c&&0==c.length&&a.registroSeleccionado.pacientes.push({nombre:"",edad:"",sexo:"",observacion:""}),a.InitWatch(),a.generarObjetoTimeLine(),a.$on("$destroy",function(){m.removeAllListeners()})},BuscarDomicilio:function(){if(a.registroSeleccionado.direccion&&!(a.registroSeleccionado.direccion.length<3)){var b=a.registroSeleccionado.direccion;a.registroSeleccionado.direccion.indexOf(" y ")!=-1&&(b=a.registroSeleccionado.direccion.substr(a.registroSeleccionado.direccion.indexOf(" y ")+3)),h.searchAddress(b,"neuquen").then(function(b){if(200==b.status){var c=[],d="";a.registroSeleccionado.direccion.indexOf(" y ")!=-1&&(d=a.registroSeleccionado.direccion.substr(0,a.registroSeleccionado.direccion.indexOf(" y ")+3));for(var e=0,f=b.data.length;e<f;e++)c.push({text:d+""+b.data[e]._source.nombre,obj:b.data[e]});a.streetSearchResult=c}else k.swal("Error","Verifique su conexi贸n a internet","error")})}},DomicilioSelected:function(b){if(void 0!=b)switch(b.obj._index){case"escuelas":a.avoidGeoCode=!0,a.marker_alta.coords.latitude=b.obj._source.latitude,a.marker_alta.coords.longitude=b.obj._source.longitude,a.map_alta.control.refresh({latitude:b.obj._source.latitude,longitude:b.obj._source.longitude});break;default:a.avoidGeoCode=!1}},UbicarPuntoFormaManual:function(){a.marker_alta.coords=a.cityCoords},GeoCode:function(){a.avoidGeoCode||!a.registroSeleccionado.direccion||a.registroSeleccionado.direccion.length<3||(a.googleMapLoading=!0,h.geoCode(e("lowercase")(a.registroSeleccionado.direccion)).then(function(b){b.length>0?(a.marker_alta.coords.latitude=b[0].lat,a.marker_alta.coords.longitude=b[0].lon,a.map_alta.control.refresh({latitude:b[0].lat,longitude:b[0].lon})):(a.marker_alta.coords.latitude=null,a.marker_alta.coords.longitude=null),a.googleMapLoading=!1}))},crearNuevoRegistro:function(){a.seleccionarRegistro(null)},StopWatch:function(){a.watchRegistros&&a.watchRegistros(),a.watchCoords&&a.watchCoords()},InitWatch:function(){a.watchRegistros=a.$watch("registroSeleccionado",function(b,c){if(!angular.equals(b,c)&&angular.equals(c.salidas,b.salidas)){if(!angular.equals(c.pacientes,b.pacientes)){var d=e("filter")(b.pacientes,function(a){if(""==a.edad&&""==a.nombre)return!0});d&&0==d.length&&a.registroSeleccionado.pacientes.push({nombre:"",edad:"",sexo:"",observacion:""})}a.mostrarBotonGuardar=!0}},!0),a.watchCoords=a.$watch("marker_alta.coords",function(b,c){angular.equals(b,c)||(null==b.latitude&&null==b.longitude?a.registroSeleccionado.coordenadas=null:a.registroSeleccionado.coordenadas=[b.longitude,b.latitude],a.mostrarBotonGuardar=!0)},!0)},cambiosSinGuardar:function(){return!!a.mostrarBotonGuardar&&(k.swal("Atenci贸n","Para continuar guarde los cambios.","info"),!0)},init:function(){if(a.loadingPrincipal=!0,"0"!=c.id)d.getById(c.id).then(function(b){a.registroSeleccionado=b,a.initData(),a.initSocket(),i.getConstantes().then(function(b){a.finalizaciones=b.tipos_salida,a.loadingPrincipal=!1})});else{console.log("Nuevo Registro");var b={nombreContacto:"",telefonoContacto:"",direccion:"",referenciaDireccion:"",clasificacion:0,observaciones:"",observacionesClasificacion:"",coordenadas:[],fechaRegistro:null,fechaCierre:null,idUsuario:"",pacientes:[],salidas:[],mensajes:[]};a.registroSeleccionado=JSON.parse(JSON.stringify(b)),a.initData(),i.getConstantes().then(function(b){a.finalizaciones=b.tipos_salida,a.loadingPrincipal=!1})}}}),a.init()}]),appModule.controller("LoginController",["$rootScope","$scope","$location","$window","LoginService",function(a,b,c,d,e){angular.extend(b,{login:function(){e.login(b.username,b.password).then(function(e){200==e.status?(d.sessionStorage.token=e.data.token,c.path("/"),a.$emit("userDataUpdated",!0)):(d.sessionStorage.clear(),b.mensaje=e.data,a.$emit("userDataUpdated",!0))})},cambiarContrasena:function(){b.nuevaContrasena==b.nuevaContrasena2?e.cambiarContrasena(b.contrasenaActual,b.nuevaContrasena).then(function(a){200==a.status?(alert("La contrase帽a se cambi贸 correctamente"),c.path("/")):b.mensaje=a.data}):b.mensaje="Las contrase帽as no coinciden"},init:function(){"/logout"==c.path()&&(d.sessionStorage.clear(),a.$emit("userDataUpdated",!0))}}),b.init()}]),appModule.controller("SearchController",["$scope","SearchService",function(a,b){angular.extend(a,{loading:!1,resultados:[],indicadores:{salidas:0},searchOptions:{fechaInicio:null,fechaFin:null},map_alta:{center:{latitude:-38.951678,longitude:-68.059189},zoom:14,control:{}},marker_alta:{id:0,coords:{latitude:40.1451,longitude:-99.668},options:{draggable:!0}},markers:[],actualizarRegistros:function(){a.loading=!0,a.alertaCambios=!1,a.resultados=[],a.indicadores.salidas=0,b.search(a.searchOptions).then(function(b){a.resultados=b.data;for(var c=0;c<b.data.length;c++)a.indicadores.salidas+=b.data[c].salidas.length;a.loading=!1})},init:function(){new Date;a.searchOptions.fechaInicio=moment().set({hour:0,minute:0,second:0}).toDate(),a.searchOptions.fechaFin=moment().set({hour:23,minute:59,second:59}).toDate()}}),a.init()}]),appModule.controller("MainController",["$rootScope","$scope","$window","LoginService","MensajesService","mySocket","SweetAlert","$interval",function(a,b,c,d,e,f,g,h){angular.extend(b,{appName:"Raph - Central 107",userData:d.getUserData(),socketConnected:!1,smsList:[],openchat:!1,unreadChatCount:0,txtSms:"",chatTimer:null,toggleChat:function(){b.openchat||(b.unreadChatCount=0),b.openchat=!b.openchat},init:function(){a.$on("userDataUpdated",function(a,c){b.userData=d.getUserData()}),a.$on("eventDetailGenerated",function(a,c){b.txtSms=c}),b.getChatlist(),b.initSocket()},getChatlist:function(){b.chatTimer=h(function(){e.listarSms().then(function(a){b.smsList=a,angular.isDefined(b.chatTimer)&&(h.cancel(b.chatTimer),b.chatTimerop=void 0)})},5e3)},initSocket:function(){f.on("connect",function(a){b.socketConnected=!0}),f.on("connect_error",function(a){b.socketConnected=!1}),f.on("chatChange",function(a){b.smsList.push(a),b.openchat||b.unreadChatCount++})},enviarSMS:function(){if(b.txtSms.length>0){b.sendingChat=!0;var a={mensaje:b.txtSms};e.nuevoSMS(a).then(function(a){b.sendingChat=!1,200==a.status?(b.txtSms="",b.registroSeleccionado=a.data,b.initData()):g.swal("Atenci贸n","Su mensaje no pudo ser enviado. Verifique su conexi贸n a internet.","error")})}}}),b.init()}]),appModule.controller("monitorController",["$scope","$http","LoginService","SweetAlert","$filter","RegistrosService","SalidasService","mySocket",function(a,b,c,d,e,f,g,h){angular.extend(a,{loading:!1,registros:[],connectedRef:null,txtNombre:"",moviles:[],puntos:[],puntos2:[],map:{control:{},center:{latitude:-38.9502426,longitude:-68.0560002},zoom:14},marker:{id:0,options:{opacity:1,labelContent:"",labelAnchor:"10 60",labelClass:"marker-labels"},coords:{latitude:40.1451,longitude:-99.668}},initSocket:function(){h.on("connect",function(b){console.log("conecto"),a.loading=!1}),h.on("connect_error",function(b){console.log("Desconecto"),a.loading=!0}),h.on("dbChange",function(b){a.actualizarRegistros()}),h.on("MovilPositionChange",function(b){a.actualizarMoviles(b)})},actualizarRegistros:function(){f.listar().then(function(b){a.registros=b;for(var c=0;c<a.registros.length;c++){var d="";switch(a.registros[c].clasificacion){case 1:d="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|50a843";break;case 2:d="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|eff464";break;case 3:d="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|FE7569";break;default:d="https://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|899393"}var e={labelContent:a.registros[c].observacionesClasificacion,labelClass:"marker-labels",icon:{url:d}};a.registros[c].options=e}})},actualizarMoviles:function(b){if(0!=a.moviles.length)for(var c=0;c<a.moviles.length;c++)a.moviles[c]._id==b._id&&(a.moviles[c].movimiento=b.movimiento,a.moviles[c].device=b.device,a.moviles[c].estado=b.estado,a.ActualizarMarkerMoviles(b._id))},ActualizarMarkerMoviles:function(b){for(var c=0;c<a.moviles.length;c++)if(!b||a.moviles[c]._id==b){var d={labelContent:a.moviles[c].nombre,labelAnchor:"20 50",labelClass:"marker-labels",icon:{path:"M 0 0 L 5 20 L -5 20 z",fillColor:1==a.moviles[c].estado?"#32db18":"#e8593a",fillOpacity:.7,scale:1,strokeColor:(1==a.moviles[c].estado,"#000"),rotation:a.moviles[c].movimiento.course,strokeWeight:1}};a.moviles[c].options=d}},IsMobileOnline:function(a){var b=new Date(a),c=new Date;return b.getTime()>c.setMinutes(c.getMinutes()-3)},ImprimirHistorialEnPantalla:function(a,b){var c=firebase.database().ref("Historial/"+a+"/device").limitToLast(20),f=c.on("value",function(a){var g=Object.keys(a.val()).map(function(b){return a.val()[b]}),h="",j="";for(i=0;i<g.length;i++)switch(j="<small><i>"+e("date")(new Date(g[i].fecha),"dd/MM/yyyy HH:mm")+"</i></small> - ",g[i].tipo){case"battery_low":h+=g[i].value?j+"Bater铆a baja. <br/>":j+"Bater铆a normal.<br/>";break;case"mobile_data":h+=g[i].value?j+"Datos m贸viles activados. <br/>":j+"Datos m贸viles desactivados.<br/>";break;case"isGpsOn":h+=g[i].value?j+"GPS activado.<br/>":j+"GPS desactivado.<br/>";break;case"reboot":h+=g[i].value?j+"Reinicio del tel茅fono registrado.<br/>":j+"Error en el registro de reboot - Avisar a Sebasti谩n!<br/>";break;case"remote_config":break;case"isAirplaneModeOn":h+=g[i].value?j+"Modo avi贸n activado.<br/>":j+"Modo avi贸n desactivado.<br/>"}c.off("value",f),d.swal({html:!0,title:"<i>Historial "+b+"</i>",text:h,type:"info"})})},Dibujar100Puntos:function(){var c=a.map.control.getGMap();a.puntos=Object.keys(a.moviles[2].historial).map(function(b){return a.moviles[2].historial[b]});for(var d=0,e=400;e<a.puntos.length;e++)d++,d>5&&(d=0,a.puntos2.length<95&&a.puntos2.push(a.puntos[e].latitud+","+a.puntos[e].longitud));var f=a.puntos2.join("|");b.get("https://roads.googleapis.com/v1/snapToRoads?interpolate=true&key=AIzaSyBeuihfLrTLC9Y_K_iQUKMRmHEvibpp0Y4&path="+f).then(function(a){for(var b=a.data,d=[],e=[],f=0;f<b.snappedPoints.length;f++){var g=new google.maps.LatLng(b.snappedPoints[f].location.latitude,b.snappedPoints[f].location.longitude);d.push(g),e.push(b.snappedPoints[f].placeId)}var h=new window.google.maps.Polyline({path:d,strokeColor:"black",strokeWeight:3});h.setMap(c)})},CentrarMapa:function(b){a.map.center={latitude:b.latitude,longitude:b.longitude}},Init:function(){a.initSocket(),a.actualizarRegistros(),g.getMovilesDisponibles().then(function(b){a.moviles=e("filter")(b.data,function(a,b,c){return void 0!=a.movimiento}),a.ActualizarMarkerMoviles()}),a.$on("$destroy",function(){h.removeAllListeners()})}}),a.Init()}]),appModule.controller("NuevoController",["$rootScope","$scope","$location","$window","RegistrosService","$filter","SalidasService","MensajesService","SearchService","UtilService","$http","LoginService","mySocket","$timeout","LlamadosService","SweetAlert",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){angular.extend(b,{loading:!1,registros:[],motivoSeleccionado:0,idRegistro:0,mostrarEvento:function(a){c.path("/evento/"+a)},seleccionarRegistro:function(a){b.idRegistro=a},loadLlamadoDuplicado:function(){b.motivoSeleccionado=2,e.listar(!0).then(function(a){b.registros=a})},loadLlamadoNoRelacionado:function(){b.motivoSeleccionado=3},saveLlamadoDuplicado:function(){b.llamadoDuplicadoLoading=!0,o.nuevoLlamado(b.idRegistro,2,b.telefono,b.mensaje).then(function(){b.llamadoDuplicadoLoading=!1,p.swal("","El llamado telef贸nico se registr贸 correctamente.","success"),c.path("/")})},saveLlamadoNoRelacionado:function(){b.llamadoDuplicadoLoading=!0,o.nuevoLlamado(null,3,b.telefono,b.mensaje).then(function(){b.llamadoDuplicadoLoading=!1,p.swal("","El llamado telef贸nico se registr贸 correctamente.","success"),c.path("/")})},init:function(){}}),b.init()}]),appModule.controller("BuscarLlamadosController",["$scope","$location","LlamadosService","SweetAlert",function(a,b,c,d){angular.extend(a,{loading:!1,resultados:[],searchOptions:{fechaInicio:null,fechaFin:null},actualizarLlamados:function(){a.loading=!0,a.resultados=[],c.search(a.searchOptions).then(function(b){a.resultados=b.data,a.loading=!1})},init:function(){new Date;a.searchOptions.fechaInicio=moment().set({hour:0,minute:0,second:0}).toDate(),a.searchOptions.fechaFin=moment().set({hour:23,minute:59,second:59}).toDate()}}),a.init()}]),appModule.factory("authInterceptor",["$rootScope","$q","$window","$location",function(a,b,c,d){return{request:function(a){return a.headers=a.headers||{},c.sessionStorage.token&&(a.headers.Authorization="Bearer "+c.sessionStorage.token),a},responseError:function(a){return 401===a.status&&d.path("/login"),b.reject(a)}}}]),appModule.factory("LoginService",["$http","$window","jwtHelper",function(a,b,c){return{login:function(b,c){return a({method:"post",url:"auth/login",data:{username:b,password:c}}).then(function(a){return a},function(a){return a})},getUserData:function(){return b.sessionStorage.token?c.decodeToken(b.sessionStorage.token):null},cambiarContrasena:function(d,e){if(b.sessionStorage.token){var f=c.decodeToken(b.sessionStorage.token),g={username:f.username,actual:d,nueva:e};return a({method:"post",url:"auth/changepassword",data:g}).then(function(a){return a},function(a){return a})}return null}}}]),appModule.factory("MensajesService",["$http",function(a){return{nuevoMensaje:function(b,c){var d={idRegistro:b,mensaje:c};return a({method:"post",url:"api/mensajes/nuevo",data:d}).then(function(a){return a},function(a){return a})},nuevoSMS:function(b){return a({method:"post",url:"api/chats/sendsms",data:b}).then(function(a){return a},function(a){return a})},listarSms:function(b){var c={ultimaFecha:b};return a({method:"post",url:"api/chats/list/",data:c}).then(function(a){return a.data})}}}]),appModule.factory("RegistrosService",["$http",function(a){return{getById:function(b){return a({method:"get",url:"api/registro/"+b}).then(function(a){return a.data})},listar:function(b){var c={mostrarEventosFinalizados:b};return a({method:"post",url:"api/registros/list/",data:c}).then(function(a){return a.data})},guardarCambios:function(b){return a({method:"post",url:"api/registros/nuevoRegistro",data:b}).then(function(a){return a},function(a){return a})},cerrarRegistro:function(b){return a({method:"post",url:"api/registros/cerrar",data:{_id:b}}).then(function(a){return a},function(a){return a})}}}]),appModule.factory("SalidasService",["$http","$q",function(a,b){return{ByIdRegistro:function(b){return a({method:"get",url:"api/salidas/"+b}).then(function(a){return a.data})},indicarMovimiento:function(b,c){var d={
idRegistro:b,idSalida:c};return a({method:"post",url:"api/registros/salidas/indicarMovimiento",data:d}).then(function(a){return a},function(a){return a})},indicarArribo:function(b,c){var d={idRegistro:b,idSalida:c};return a({method:"post",url:"api/registros/salidas/indicarArribo",data:d}).then(function(a){return a},function(a){return a})},indicarDestino:function(b,c){var d={idRegistro:b,idSalida:c._id,nombre:c.tipoSalida.nombre,destino:c.tipoSalida.destino};return a({method:"post",url:"api/registros/salidas/indicarDestino",data:d}).then(function(a){return a},function(a){return a})},indicarQRU:function(b,c){return a({method:"post",url:"api/registros/salidas/indicarQRU",data:{idRegistro:b,idSalida:c}}).then(function(a){return a},function(a){return a})},indicarCancelacion:function(b,c){return a({method:"post",url:"api/registros/salidas/indicarCancelacion",data:{idRegistro:b,idSalida:c}}).then(function(a){return a},function(a){return a})},nuevaSalida:function(b,c){var d={idMovil:b,_id:c};return a({method:"post",url:"api/registros/salidas/nueva",data:d}).then(function(a){return a},function(a){return a})},getMovilesDisponibles:function(c){function d(a,c){var d=b.defer(),e=new google.maps.DistanceMatrixService;return e.getDistanceMatrix({origins:a,destinations:c,travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.METRIC,avoidHighways:!1,avoidTolls:!1},function(a,b){b!==google.maps.DistanceMatrixStatus.OK?d.reject(b):d.resolve(a)}),d.promise}var e=b.defer(),f={};return c&&2==c.length&&(f={latitud:c[1],longitud:c[0]}),a({method:"post",url:"api/moviles",data:f}).then(function(a){if(c&&2==c.length){for(var b=[{lat:c[1],lng:c[0]}],f=[],g=0;g<a.data.length;g++)f.push({lat:a.data[g].obj.posicion[1],lng:a.data[g].obj.posicion[0]});d(f,b).then(function(b){for(var c=0;c<a.data.length;c++)a.data[c].distance=b.rows[c].elements[0].distance,a.data[c].duration=b.rows[c].elements[0].duration;e.resolve(a)})}else e.resolve(a)},function(a){return a}),e.promise}}}]),appModule.factory("SearchService",["$http","$filter","$window","$q",function(a,b,c,d){return{search:function(b){return a({method:"post",url:"api/search/events",data:b}).then(function(a){return a})},searchCie10:function(b){var c={direccion:b};return a({method:"post",url:"api/search/cie10",data:c}).then(function(a){return a})},searchAddress:function(b,c){var d={direccion:b,ciudad:c};return a({method:"post",url:"api/search/streets",data:d}).then(function(a){return a})},geoCode:function(a){var b=(a.replace(" ","%20"),d.defer()),e=new c.google.maps.Geocoder;return e.geocode({address:a,componentRestrictions:{locality:"neuqu茅n"}},function(a,d){if(d===c.google.maps.GeocoderStatus.OK)if(a.length>0){var e=[];if("Neuqu茅n, Argentina"!=a[0].formatted_address)var e=[{lat:a[0].geometry.location.lat(),lon:a[0].geometry.location.lng()}];b.resolve(e)}else b.resolve([]);else b.reject()}),b.promise}}}]),appModule.factory("mySocket",["socketFactory",function(a){return a()}]),appModule.factory("UtilService",["$http",function(a){return{getConstantes:function(){return a({method:"get",url:"api/constantes"}).then(function(a){return a.data})}}}]),appModule.factory("LlamadosService",["$http",function(a){return{nuevoLlamado:function(b,c,d,e){var f={registro:b,tipo:c,telefono:d,mensaje:e};return a({method:"post",url:"api/llamados/nuevo",data:f}).then(function(a){return a},function(a){return a})},search:function(b){return a({method:"post",url:"api/search/llamados",data:b}).then(function(a){return a})}}}]);